name: CI-CD-SONARQUBE-TEST # Nombre del workflow

on: # Eventos que activan el workflow
  push:
    branches: # Git push activar√° el workflow al realizarse en estas ramas
      - main
      - dev
      - feature

env: # Variables de entorno
  SONAR_TOKEN: ${{ secrets.MAIN_TOKEN }} # Token for main branch
  JAVA_SRC: src/com/example/sqlinjectiontest # Directorio del fichero Main.java
  PYTHON_DIR: python # Directorio del fichero file.py
  RESULTS_DIR: results # Directorio de los resultados

jobs: # Conjunto de las tareas
  build-test: # Nombre de la tarea (job)
    runs-on: ubuntu-latest # Virtualiza en Ubuntu

    steps: # Pasos de la tarea
    - name: üì• Clonar repositorio
      uses: actions/checkout@v4

    # ------------ JAVA BUILD & TEST ------------
    - name: ‚òï Congigurando JDK 17... # Instala y configura Java - ZULU
      uses: actions/setup-java@v2
      with:
        java-version: '17' 
        distribution: 'zulu'

    - name: üì¶ Instalando Checkstyle para Java...
      run: |
        wget -O checkstyle.jar https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.12.1/checkstyle-10.12.1-all.jar
        wget -O google_checks.xml https://raw.githubusercontent.com/checkstyle/checkstyle/checkstyle-10.12.1/src/main/resources/google_checks.xml

    - name: üöÄ Ejecutando Checkstyle (Java)...
      run: |
        mkdir -p ${{ env.RESULTS_DIR }}/java
        java -jar checkstyle.jar -c google_checks.xml src/com/example/sqlinjectiontest/Main.java | tee ${{ env.RESULTS_DIR }}/java/checkstyle-output.txt || true
      continue-on-error: true

    - name: üõ†Ô∏è Compilando c√≥digo Java...
      run: |
        javac ${{ env.JAVA_SRC }}/Main.java -d build
      continue-on-error: true

    - name: üì¶ Descargando JUnit... # Instala y configura JUnit
      run: |
        wget -O junit-platform-console-standalone-1.10.0.jar \
        https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.10.0/junit-platform-console-standalone-1.10.0.jar

    - name: üß™ Ejecutando tests unitarios Java (JUnit 5)...
      run: |
        wget -O junit-platform-console-standalone-1.10.0.jar \
        https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.10.0/junit-platform-console-standalone-1.10.0.jar

        java -jar junit-platform-console-standalone-1.10.0.jar \
          --class-path build:tests:junit-platform-console-standalone-1.10.0.jar \
          --scan-class-path | tee ${{ env.RESULTS_DIR }}/java/junit-results.txt
      continue-on-error: true

    - name: üöÄ Ejecutando c√≥digo Java...
      run: java -cp build com.example.sqlinjectiontest.Main | tee ${{ env.RESULTS_DIR}}/java/java-output.txt || true

    - name: üßπ Limpiando compilados...
      run: rm -rf build

    # ------------ PYTHON TESTS ------------
    - name: üêç Configurando Python... # Instala y configura Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: üì¶ Instalando las dependencias para Python... # Instala las librerias de Python a usar
      run: |
        pip install pytest flake8 bandit black

    - name: ‚úèÔ∏è Chequeando estilos (flake8)... # Ejecuta flake8
      run: |
        mkdir -p ${{ env.RESULTS_DIR }}/python
        flake8 python/ | tee ${{ env.RESULTS_DIR }}/python/flake-results.txt
      continue-on-error: true
  
    - name: üìä Chequeando formato (black)... # Ejecuta black
      run: black --check python/ | tee ${{ env.RESULTS_DIR }}/python/black-results.txt
      continue-on-error: true

    - name: üïµüèª‚Äç‚ôÇÔ∏è Ejecutando an√°lisis de seguridad (bandit)... # Ejecuta bandit en busca de vulnerabilidades
      run: bandit -r python/ -x tests/ -s B101 | tee ${{ env.RESULTS_DIR }}/python/bandit-results.txt # Ignora el assert de python (-x tests/ -s B101)
      continue-on-error: true

    - name: üß™ Ejecutando pytests... # Ejecuta los pytests
      run: |
        mkdir -p ${{ env.RESULTS_DIR }}/python
        pytest -s -v --disable-warnings python/file.py | tee ${{ env.RESULTS_DIR }}/python/pytest-results.txt
      continue-on-error: true
      
    # ------------ ARTIFACTS ------------
    - name: üìÅ Almanceando resultados... # Almacena los resultados de las pruebas
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: results/

    # ------------ SUMMARY ------------
    - name: üìã Resumen # Resumen de las tareas de Java y Python
      run: |
        echo "‚úÖ Java and Python tasks completed."
        echo "üìÑ Outputs stored in 'results/' and uploaded as artifacts."

    - name: üì¶ Instalando Sonar Scanner...
      run: |
        wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
        unzip sonar-scanner-cli-5.0.1.3006-linux.zip
        mv sonar-scanner-5.0.1.3006-linux sonar-scanner
        echo "$(pwd)/sonar-scanner/bin" >> $GITHUB_PATH

    - name: ‚òëÔ∏è Verificando SonarQube...
      run: |
        curl -I http://rnduk-77-211-5-159.a.free.pinggy.link || true

    - name: üöÄ Ejecutando escaneo de SonarQube...
      run: |
        sonar-scanner \
          -Dsonar.projectKey=VariosTests \
          -Dsonar.host.url=http://rnduk-77-211-5-159.a.free.pinggy.link \
          -Dsonar.token=${{ secrets.MAIN_TOKEN }} \
          -Dsonar.sources=python,src \
          -Dsonar.python.version=3.x \
          -Dsonar.qualitygate.wait=true \
          -X
